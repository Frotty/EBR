package Trap
import BaseObject
import Escaper
import EventHandling
import DummyCaster
import Camera
import GameConstants
import TempGroups
import Texttag
import Camerashakes

constant int TRAP_ID = 'n00I'
constant string POISON_EFFECT = "Abilities\\Weapons\\PoisonSting\\PoisonStingTarget.mdl" 
constant real EVENT_RADIUS = 64.

string array SFX_STRINGS
enum ABIL
	KILL
	STUN
	POISON
	SPEED
	KNOCK
	SHAKE
	
public class Trap extends StaticBaseObject
	int sfxid = 3
	real interval = 2.
	real timerreal = 0.
	ABIL a
	
	real duration //Shake,  Speed, Stun
	real value // Shake, Knockback, Speed
	boolean pull = false
	
	construct( vec2 pos, player owner )
			super(pos, CreateUnit( owner, TRAP_ID, pos.x, pos.y, 0.  ) , EVENT_RADIUS, function onStep)
			active = false
			actor.registerCastEvent(Condition(function Trap.onCast))
			actor.setUserData(this castTo int)

			
	static function onStep()
		debugPrint("Trap step", 1)
		unit source = GetTriggeringTrigger().getSource()
		unit u = GetTriggerUnit()
		Entity e = u.getUserData() castTo Entity
		thistype obj = source.getUserData() castTo thistype
		
		if not obj.active and e instanceof Escaper
			DestroyEffect(AddSpecialEffect(SFX_STRINGS[obj.sfxid],obj.actor.getX(),obj.actor.getY() ))
			var escaper = e castTo Escaper
			obj.doEffect(escaper)
	
	function canTrigger(Entity e) returns boolean
		return false
	
	override function update()
		debugPrint(". . . "+timerreal.toString(), 1)
		super.update()
		if active
			if timerreal <= 0.0
				DestroyEffect(AddSpecialEffect(SFX_STRINGS[sfxid],actor.getX(),actor.getY() ))
				GroupEnumUnitsInRange(ENUM_GROUP,actor.getX(), actor.getY(), EVENT_RADIUS, null)
				for unit u in ENUM_GROUP
					Entity e = u.getUserData() castTo Entity
					if e instanceof Escaper
						var escaper = e castTo Escaper
						doEffect(escaper)
				ENUM_GROUP.clear()
				timerreal = interval
			else
				timerreal -= ANIMATION_PERIOD
				
	function doEffect(Escaper e)
		debugPrint("Trap Effect", 1)
		switch a
			case ABIL.KILL
				e.kill()
			case ABIL.STUN
				var dc = new DummyCaster(STUN_BUFF, "thunderbolt", DUMMY_PLAYER, true)
				dc.setLevel(duration.toInt())
				dc.castOnTarget(e.actor)
			case ABIL.SHAKE
				newEventPlayer(e.owner,value)
				//setCameraNoiseTimed(e.owner, value, 1000, duration)
			case ABIL.POISON
				e.setPoison(true)
				//if not e.poisoned
				//	e.poisoned = true
				//	e.poisonEffect = AddSpecialEffectTarget(POISON_EFFECT, e.actor, "chest")
			case ABIL.SPEED
				int level = (value/20).toInt()
				debugPrint("level = " +level.toString(),3)
				if level < 5
					debugPrint("DC created1", 3)
					var dc = new DummyCaster(SPEED_BUFF_NEG, "bloodlust", DUMMY_PLAYER, true)
					debugPrint("DC created2", 3)
					dc.setLevel(level)
					dc.castOnTarget(e.actor)
				if level > 5
					debugPrint("DC created1.1", 3)
					var dc = new DummyCaster(SPEED_BUFF_POS, "bloodlust", owner, true)
					debugPrint("DC created2.1", 3)
					dc.setLevel(level-5)
					dc.castOnTarget(e.actor)
				debugPrint("finish", 3)
			case ABIL.KNOCK
				IssueImmediateOrder(e.actor, "stop")
				real rX = getRallyX()
				real rY = getRallyY()
				real aX = actor.getX()
				real aY = actor.getY()
				angle angl
				if getRallyUnit() == actor
					rX = aX
					rY = aY
				debugPrint("dist " +distanceBetweenCoords(rX, rY, aX, aY).toString(), 1)
				if distanceBetweenCoords(rX, rY, aX, aY) < 20
					if pull
						angl = (angleBetweenCoords(aX, aY,e.actor.getX(), e.actor.getY()).degrees()-180.).asAngleDegrees()
					else
						angl = angleBetweenCoords(aX, aY,e.actor.getX(), e.actor.getY())
				else	
					angl = angleBetweenCoords(aX, aY,rX, rY)
				e.addVel( vec3(value * Cos(angl.radians()),value * Sin(angl.radians()),0.))

			default
				skip
		
		
	function addConfiger(boolean dur, boolean val)
		UnitRemoveAbility(actor,KILL_ABIL)
		UnitRemoveAbility(actor,STUN_ABIL)
		UnitRemoveAbility(actor,SHAKE_ABIL)
		UnitRemoveAbility(actor,SPEED_ABIL)
		UnitRemoveAbility(actor,KNOCK_ABIL)
		UnitRemoveAbility(actor,POISON_ABIL)
		UnitAddAbility(actor,INCREASE_INTERVAL_ABIL)
		UnitAddAbility(actor,DECREASE_INTERVAL_ABIL)
		UnitAddAbility(actor,START_ABIL)
		UnitAddAbility(actor,NEXT_SFX_ABIL)
		UnitAddAbility(actor,PREV_SFX_ABIL)
		if dur
			UnitAddAbility(actor,INCREASE_DURATION_ABIL)
			UnitAddAbility(actor,DECREASE_DURATION_ABIL)
		if val
			UnitAddAbility(actor,INCREASE_VALUE_ABIL)
			UnitAddAbility(actor,DECREASE_VALUE_ABIL)
	
	static function onCast() returns boolean
		debugPrint("Trap Casting", 1)
		unit source = GetSpellAbilityUnit()
		thistype obj = source.getUserData() castTo thistype
		int spell_id = GetSpellAbilityId()
		switch spell_id
			case NEXT_SFX_ABIL
				debugPrint(obj.sfxid.toString(), 1)
				if obj.sfxid >= SFX_COUNT
					obj.sfxid = 0
				else
					obj.sfxid ++
				if obj.sfxid < SFX_COUNT
					DestroyEffect(AddSpecialEffect(SFX_STRINGS[obj.sfxid],obj.actor.getX(),obj.actor.getY() ))
				else
					createTTEx(obj.pos, vec2(0,0.05), "|cffC51019No Effect", 14,  2., colorA(255,255,255,0), obj.owner  )
			case PREV_SFX_ABIL
				debugPrint(obj.sfxid.toString(), 1)
				if obj.sfxid <= 0
					obj.sfxid = SFX_COUNT
				else
					obj.sfxid --
				if obj.sfxid < SFX_COUNT
					DestroyEffect(AddSpecialEffect(SFX_STRINGS[obj.sfxid],obj.actor.getX(),obj.actor.getY() ))
				else
					createTTEx(obj.pos, vec2(0,0.05), "|cffC51019No Effect", 14,  2., colorA(255,255,255,0), obj.owner  )
			
			case KILL_ABIL
				obj.a = ABIL.KILL
				obj.addConfiger(false, false)
			case STUN_ABIL
				obj.a = ABIL.STUN
				obj.duration = 1.
				obj.addConfiger(true, false)
			case SPEED_ABIL
				//createTTEx(obj.pos, vec2(0,0.05), "|cffC51019Not implemented yet", 10,  2., colorA(255,255,255,0), obj.owner  )
				obj.a = ABIL.SPEED
				obj.value = 120.
				obj.duration = 1.
				obj.addConfiger(false, true)
			case SHAKE_ABIL
				obj.a = ABIL.SHAKE
				obj.value = 500
				obj.duration = 3.
				obj.addConfiger(true, true)
			case KNOCK_ABIL
				obj.a = ABIL.KNOCK
				obj.value = 10.
				obj.actor.addAbility('ARal')
				obj.actor.addAbility(PULL_ID)
				obj.addConfiger(false, true)
			case POISON_ABIL
				obj.a = ABIL.POISON
				debugPrint("POISON",1)
				obj.addConfiger(false, false)
					
			case INCREASE_INTERVAL_ABIL
				if obj.interval >= 10
					createTTEx(obj.pos, vec2(0,0.05), "|cffC51019Max", 10,  2., colorA(255,255,255,0), obj.owner  )
				else
					obj.interval += 0.25
					createTTEx(obj.pos, vec2(0,0.05), "|cffC51019Intervall "+ R2SW(obj.interval,1,2), 10,  2., colorA(255,255,255,0), obj.owner  )
			case DECREASE_INTERVAL_ABIL
				if obj.interval < 0.75
					createTTEx(obj.pos, vec2(0,0.05), "|cffC51019Min", 10,  2., colorA(255,255,255,0), obj.owner  )
				else
					obj.interval -= 0.25
					createTTEx(obj.pos, vec2(0,0.05), "|cffC51019Intervall "+ R2SW(obj.interval,1,2), 10,  2., colorA(255,255,255,0), obj.owner  )
			
			case INCREASE_VALUE_ABIL
				switch obj.a
					case ABIL.KNOCK
						if obj.value >= 50
							createTTEx(obj.pos, vec2(0,0.05), "|cffC51019Max Force", 10,  2., colorA(255,255,255,0), obj.owner  )
						else
							obj.value += 5
							createTTEx(obj.pos, vec2(0,0.05), "|cffC51019Force "+ R2SW(obj.value,1,0), 10,  2., colorA(255,255,255,0), obj.owner  )
					case ABIL.SHAKE
						if obj.value >= 1500
							createTTEx(obj.pos, vec2(0,0.05), "|cffC51019Intensity Max", 10,  2., colorA(255,255,255,0), obj.owner  )
						else
							obj.value += 100
							createTTEx(obj.pos, vec2(0,0.05), "|cffC51019Intensity "+ R2SW(obj.value,1,0), 10,  2., colorA(255,255,255,0), obj.owner  )
					case ABIL.SPEED
						if obj.value >= 180
							createTTEx(obj.pos, vec2(0,0.05), "|cffC51019Max Speed", 10,  2., colorA(255,255,255,0), obj.owner  )
						else
							obj.value += 20
							createTTEx(obj.pos, vec2(0,0.05), "|cffC51019Speed Bonus "+ R2SW(obj.value,1,0)+"%", 10,  2., colorA(255,255,255,0), obj.owner  )
					default
						skip
			case DECREASE_VALUE_ABIL
				switch obj.a
					case ABIL.KNOCK
						if obj.value <= 5
							createTTEx(obj.pos, vec2(0,0.05), "|cffC51019Min Force", 10,  2., colorA(255,255,255,0), obj.owner  )
						else
							obj.value -= 5
							createTTEx(obj.pos, vec2(0,0.05), "|cffC51019Force "+ obj.value.toInt().toString(), 10,  2., colorA(255,255,255,0), obj.owner  )
					case ABIL.SHAKE
						if obj.value <= 100
							createTTEx(obj.pos, vec2(0,0.05), "|cffC51019Min Intensity", 10,  2., colorA(255,255,255,0), obj.owner  )
						else
							obj.value -= 100
							createTTEx(obj.pos, vec2(0,0.05), "|cffC51019Intensity "+ obj.value.toInt().toString(), 10,  2., colorA(255,255,255,0), obj.owner  )
					case ABIL.SPEED
						if obj.value <= 20
							createTTEx(obj.pos, vec2(0,0.05), "|cffC51019Min Speed", 10,  2., colorA(255,255,255,0), obj.owner  )
						else
							obj.value -= 20
							createTTEx(obj.pos, vec2(0,0.05), "|cffC51019Speed Bonus "+ obj.value.toInt().toString()+"%", 10,  2., colorA(255,255,255,0), obj.owner  )
					default
						skip
			
			case INCREASE_DURATION_ABIL
				switch obj.a
					case ABIL.STUN
						if obj.duration >= 4
							createTTEx(obj.pos, vec2(0,0.05), "|cffC51019Max Duration", 10,  2., colorA(255,255,255,0), obj.owner  )
						else
							obj.duration += 1
							createTTEx(obj.pos, vec2(0,0.05), "|cffC51019Duration "+ R2SW(obj.duration,1,0), 10,  2., colorA(255,255,255,0), obj.owner  )
					case ABIL.SHAKE
						if obj.duration >= 5
							createTTEx(obj.pos, vec2(0,0.05), "|cffC51019Max Duration", 10,  2., colorA(255,255,255,0), obj.owner  )
						else
							obj.duration += 1
							createTTEx(obj.pos, vec2(0,0.05), "|cffC51019Duration "+ R2SW(obj.duration,1,0), 10,  2., colorA(255,255,255,0), obj.owner  )
					case ABIL.SPEED
						if obj.duration >= 20
							createTTEx(obj.pos, vec2(0,0.05), "|cffC51019Max Duration", 10,  2., colorA(255,255,255,0), obj.owner  )
						else
							obj.duration += 1
							createTTEx(obj.pos, vec2(0,0.05), "|cffC51019Duration "+ R2SW(obj.duration,1,0), 10,  2., colorA(255,255,255,0), obj.owner  )
					default
						skip	
			case DECREASE_DURATION_ABIL
				switch obj.a
					case ABIL.STUN
						if obj.duration <= 1
							createTTEx(obj.pos, vec2(0,0.05), "|cffC51019Min Duration", 10,  2., colorA(255,255,255,0), obj.owner  )
						else
							obj.duration -= 1
							createTTEx(obj.pos, vec2(0,0.05), "|cffC51019Duration "+ R2SW(obj.duration,1,0), 10,  2., colorA(255,255,255,0), obj.owner  )
					case ABIL.SHAKE
						if obj.duration <= 1
							createTTEx(obj.pos, vec2(0,0.05), "|cffC51019Min Duration", 10,  2., colorA(255,255,255,0), obj.owner  )
						else
							obj.duration -= 1
							createTTEx(obj.pos, vec2(0,0.05), "|cffC51019Duration "+ R2SW(obj.duration,1,0), 10,  2., colorA(255,255,255,0), obj.owner  )
					case ABIL.SPEED
						if obj.duration <= 1
							createTTEx(obj.pos, vec2(0,0.05), "|cffC51019Min Duration", 10,  2., colorA(255,255,255,0), obj.owner  )
						else
							obj.duration -= 1
							createTTEx(obj.pos, vec2(0,0.05), "|cffC51019Duration "+ R2SW(obj.duration,1,0), 10,  2., colorA(255,255,255,0), obj.owner  )
					default
						skip
			
			case START_ABIL
				obj.active = true
				UnitRemoveAbility(obj.actor,START_ABIL)
				UnitAddAbility(obj.actor,STOP_ABIL)
			case STOP_ABIL
				obj.active = false
				obj.timerreal = 0.
				UnitRemoveAbility(obj.actor,STOP_ABIL)
				UnitAddAbility(obj.actor,START_ABIL)
			case PULL_ID
				obj.pull = true
				obj.actor.removeAbility(PULL_ID)
				obj.actor.addAbility(PUSH_ID)
			case PUSH_ID
				obj.pull = false
				obj.actor.removeAbility(PUSH_ID)
				obj.actor.addAbility(PULL_ID)
		return false
		
	ondestroy
		actor.unregisterCastEvent()

constant int NEXT_SFX_ABIL = 'A06D'
constant int PREV_SFX_ABIL = 'A06C'

constant int INCREASE_DURATION_ABIL = 'A026'
constant int DECREASE_DURATION_ABIL = 'A025'
constant int INCREASE_VALUE_ABIL = 'A023'
constant int DECREASE_VALUE_ABIL = 'A01S'

constant int KILL_ABIL = 'A06E'
constant int STUN_ABIL = 'A06G'
constant int SPEED_ABIL = 'A06I'
constant int SHAKE_ABIL = 'A033'
constant int KNOCK_ABIL = 'A06H'
constant int POISON_ABIL = 'A06F'

constant int STUN_BUFF = 'A06J'
constant int SPEED_BUFF_NEG = 'A03J'
constant int SPEED_BUFF_POS = 'A03I'

constant int INCREASE_INTERVAL_ABIL = 'A02O'
constant int DECREASE_INTERVAL_ABIL = 'A02Q'
constant int START_ABIL = 'A02T'
constant int STOP_ABIL = 'A02U'

constant int PULL_ID = 'A074'
constant int PUSH_ID = 'A075'

constant SFX_COUNT = 9

public function init_Trap()
	SFX_STRINGS[0] = "Abilities\\Spells\\Undead\\AnimateDead\\AnimateDeadTarget.mdl"
	SFX_STRINGS[1] = "Abilities\\Spells\\Undead\\FrostNova\\FrostNovaTarget.mdl"
	SFX_STRINGS[2] = "Abilities\\Spells\\Undead\\Impale\\ImpaleMissTarget.mdl"
	SFX_STRINGS[3] = "Abilities\\Spells\\Other\\Doom\\DoomDeath.mdl"
	SFX_STRINGS[4] = "Abilities\\Spells\\Human\\ManaFlare\\ManaFlareBoltImpact.mdl"
	SFX_STRINGS[5] = "Abilities\\Spells\\Other\\Monsoon\\MonsoonBoltTarget.mdl"
	SFX_STRINGS[6] = "Abilities\\Spells\\Other\\Volcano\\VolcanoDeath.mdl"
	SFX_STRINGS[7] = "Abilities\\Spells\\Demon\\DarkPortal\\DarkPortalTarget.mdl"
	SFX_STRINGS[8] = "Objects\\Spawnmodels\\NightElf\\NEDeathSmall\\NEDeathSmall.mdl"
	SFX_STRINGS[9] = ""
	
